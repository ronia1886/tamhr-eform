@using TAMHR.ESS.Infrastructure
@inject IScriptManager ScriptManager
@inject AclHelper AclHelper
@inject TAMHR.ESS.Infrastructure.DomainServices.ApprovalService ApprovalService
@{
    Layout = "~/Views/Shared/_Layout.cshtml";
    //var version = Microsoft.Extensions.PlatformAbstractions.PlatformServices.Default.Application.ApplicationVersion;

    ScriptManager.RegisterReferences("listview", "datepicker", "combobox", "numeric", "timepicker");

    var dicts = DocumentStatus.CssClasses;

    var showApprovalAndConversation = ViewBag.ShowApprovalAndConversation != null ? (bool)ViewBag.ShowApprovalAndConversation : true;

    var formKey = this.Context.Request.Query["formKey"].ToString();
    if (formKey == "weekly-wfh-planning") { showApprovalAndConversation = false; }
    var showActionButton = ViewBag.ShowActionButton != null ? (bool)ViewBag.ShowActionButton : true;
}
@section styles {
    <link rel="stylesheet" type="text/css" href="~/css/chat.css" />
    <link rel="stylesheet" type="text/css" href="~/plugins/bootstrap-suggest/bootstrap-suggest.css" />
    @RenderSection("styles", false)
}
@section scripts {
    <script type="text/javascript">
        kendo.ui.DatePicker.fn.options.parseFormats = ["yyyy-MM-dd"];
        kendo.ui.DatePicker.fn.options.format = "dd-MM-yyyy";

        app.set("documentApprovalId", "@Model.DocumentApprovalId");
        app.set("noreg", "@User.GetClaim("NoReg")");
        app.set("users", @Html.Raw(Newtonsoft.Json.JsonConvert.SerializeObject(ApprovalService.GetDistinctTrackingApprovalUsers(Model.DocumentApprovalId, User.GetClaim("NoReg")))));
        app.set("canCreateConversation", @AclHelper.CanCreateConversation().ToString().ToLower());
    </script>
    <script type="text/javascript" src="~/plugins/bootstrap-suggest/bootstrap-suggest.js"></script>
    @if (IsSectionDefined("formScripts"))
    {
        @RenderSection("formScripts", false)
    }
    else
    {
        <script type="text/javascript" src="~/js/app-upload.js"></script>
        <script type="text/javascript" src="~/js/pages/common-form.js"></script>
    }
    @RenderSection("scripts", false)
}
@section pageTitle {
    <div class="page-title">
        @if (Model.FormKey == "termination")
        {
            <a class="font-medium-3" href="~/others/termination/index" title="Back to request history" style="position: relative; top: 1px;">
                <i class="ft-chevron-left font-red-haze"></i>
            </a>
        }
        else
        {
            <a class="font-medium-3" href="~/core/form/index?formKey=@Model.FormKey" title="Back to request history" style="position: relative; top: 1px;">
                <i class="ft-chevron-left font-red-haze"></i>
            </a>
        }
        @(await Component.InvokeAsync<TAMHR.ESS.Infrastructure.Web.ViewComponents.Breadcrumb>())
    </div>
}
@section pageToolbars {
    @if (!ApplicationHelper.IsDefault(Model.Id) && formKey != "weekly-wfh-planning")
    {
        <div class="toolbars">
            <div class="btn-group">
                <a href="javascript:;" class="btn dark btn-sm" data-trigger="modal" data-modal-title="Tracking Approval - @Model.DocumentNumber" data-modal-ajax="true" data-ajax-url="~/core/home/trackingapproval" data-parameters-id="@Model.DocumentApprovalId">
                    <i class="icon-doc"></i> <span class="d-none d-md-inline">@Model.DocumentNumber</span>
                </a>
                @if (Model.CanDownload)
                {
                    <a href="~/core/form/download?formKey=@Model.FormKey&id=@Model.DocumentApprovalId" id="download-@Model.DocumentApprovalId" class="btn green-jungle btn-sm" target="_blank">
                        <i class="ft-download"></i>
                    </a>
                }
            </div>
        </div>
    }
    
    @* Add additional page toolbar section for annual planning forms *@
    @if (IsSectionDefined("pageToolbars"))
    {
        @RenderSection("pageToolbars", false)
    }
}

@if (IsSectionDefined("pageHeader"))
{
    @RenderSection("pageHeader", false)
}
else if (Model.DocumentStatusCode == DocumentStatus.Expired)
{
    <div class="bd-callout bd-callout-warning bg-white mt-0">
        <h5 class="bold"><i class="fa fa-warning font-yellow-casablanca"></i> @Localizer["Expired Document"]</h5>
        <p>@Localizer["This document marked as expired document"]</p>
    </div>
}
@if (!ApplicationHelper.IsDefault(Model.Id))
{
    <div class="row">
        <div class="col">
            <div class="progress" style="height: 5px;">
                <div class="progress-bar progress-bar-striped @(dicts.ContainsKey(Model.DocumentStatusCode) ? dicts[Model.DocumentStatusCode] : string.Empty)" role="progressbar" aria-valuenow="@Model.Progress" aria-valuemin="@Model.Progress" aria-valuemax="@Model.Progress" style="width: @(Model.Progress)%;"></div>
            </div>
        </div>
    </div>
}
@if (!IsSectionDefined("formContainer"))
{
    <form id="mainForm" method="@ApplicationHelper.Method(Model.Id)" action="@Url.Content(ApplicationHelper.Api(Model.FormKey))">
        @Html.Hidden("Id", Model.Id, new { @class = "form-control" })
        @Html.Hidden("DocumentApprovalId", Model.DocumentApprovalId, new { @class = "form-control" })
        @Html.Hidden("FormKey", Model.FormKey, new { @class = "form-control" })
        @RenderBody()
    </form>
}
else
{
    @RenderSection("formContainer")
}

@if (!ApplicationHelper.IsDefault(Model.Id) && showApprovalAndConversation)
{
    <div class="row">
        <div class="col-md-12">
            @(await Component.InvokeAsync<ChildRequestUrl>(new { docId = Model.DocumentApprovalId }))
        </div>
        @if (AclHelper.CanViewApprovalHistories())
        {
            <div class="col-12 col-md-@(!AclHelper.CanViewConversation() ? "12" : "7")">
                <div class="card">
                    <div class="card-header bordered">
                        <h4 class="card-title">@Localizer["Document Approval Histories"]</h4>
                        <a class="heading-elements-toggle">
                            <i class="ft-ellipsis-h font-medium-3"></i>
                        </a>
                        <div class="heading-elements">
                            <ul class="list-inline mb-0">
                                <li>
                                    <a data-action="collapse">
                                        <i class="ft-minus"></i>
                                    </a>
                                </li>
                            </ul>
                        </div>
                    </div>
                    <div class="card-body pt-0 pb-0">
                        @(await Component.InvokeAsync<DocumentApprovalHistory>(new { id = Model.DocumentApprovalId, deferred = true }))
                    </div>
                </div>
            </div>
        }
        @if (AclHelper.CanViewConversation())
        {
            <div class="col-12 col-md-5">
                <div class="card">
                    <div class="card-header bordered">
                        <h4 class="card-title">@Localizer["Conversation"]</h4>
                        <a class="heading-elements-toggle">
                            <i class="ft-ellipsis-h font-medium-3"></i>
                        </a>
                        <div class="heading-elements">
                            <ul class="list-inline mb-0">
                                <li>
                                    <a data-action="collapse">
                                        <i class="ft-minus"></i>
                                    </a>
                                </li>
                            </ul>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        @(await Component.InvokeAsync<Conversation>(new { id = Model.DocumentApprovalId }))
                    </div>
                </div>
            </div>
        }
    </div>
}
@RenderSection("pageFooter", false)
@if (showActionButton)
{
    if (!IsSectionDefined("formActions"))
    {
        @await Html.PartialAsync("Components/_ActionButtons")
    }
    else
    {
        @RenderSection("formActions")
    }
}