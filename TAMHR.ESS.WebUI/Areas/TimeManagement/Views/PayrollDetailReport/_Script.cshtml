<script>
    var firstTimeLoad = true;

    $.OnChangeDirectorate = function (e) {
        var directorates = $("#directorate").data("kendoDropDownTree").value();

        var directorateValue = [];

        directorates.forEach(
            Directorate =>
                directorateValue.push(Directorate.split('#')[0])
        )

        var child = $("#division").data("kendoDropDownTree");
        $.ajax({
            method: "POST",
            url: "@Url.Content("~/api/payroll-detail//get-division")",
            dataType: "json",   
            data: { DirectorateList: directorateValue },
            success: function (result) {
                var listItem = [];
                result.forEach(elements => listItem.push({text: elements.Text, value: elements.Value}));
                var dataSource = new kendo.data.HierarchicalDataSource({
                    data:  listItem
                });
                child.setDataSource(dataSource);
                child.enable(true);
                child.trigger("change");
            }
        });
    }

    $.OnChangeDivision = function (e) {
        var divisions = $("#division").data("kendoDropDownTree").value();

        var divisionValue = [];

        divisions.forEach(
            division =>
                divisionValue.push(division.split('#')[0])
        )
        

        var child = $("#department").data("kendoDropDownTree");
        $.ajax({
            method: "POST",
            url: "@Url.Content("~/api/payroll-detail//get-department")",
            dataType: "json",   
            data: { DivisionList: divisionValue },
            success: function (result) {
                var listItem = [];
                result.forEach(elements => listItem.push({text: elements.Text, value: elements.Value}));
                var dataSource = new kendo.data.HierarchicalDataSource({
                    data:  listItem
                });
                child.setDataSource(dataSource);
                child.enable(true);
                child.trigger("change");
            }
        });
    }

    $.OnChangeDepartment = function (e) {
        var departments = $("#department").data("kendoDropDownTree").value();

        var departmentValue = [];

        departments.forEach(
            department =>
                departmentValue.push(department.split('#')[0])
        )

        var child = $("#section").data("kendoDropDownTree");
        $.ajax({
            method: "POST",
            url: "@Url.Content("~/api/payroll-detail//get-section")",
            dataType: "json",   
            data: { DepartmentList: departmentValue },
            success: function (result) {
                var listItem = [];
                result.forEach(elements => listItem.push({text: elements.Text, value: elements.Value}));
                var dataSource = new kendo.data.HierarchicalDataSource({
                    data:  listItem
                });
                child.setDataSource(dataSource);
                child.enable(true);
                child.trigger("change");
            }
        });
    }

    $.OnChangeSection = function (e) {
        var sections = $("#section").data("kendoDropDownTree").value();

        var sectionValue = [];

        sections.forEach(
            section =>
                sectionValue.push(section.split('#')[0])
        )

        var child = $("#line").data("kendoDropDownTree");
        $.ajax({
            method: "POST",
            url: "@Url.Content("~/api/payroll-detail//get-line")",
            dataType: "json",   
            data: { SectionList: sectionValue },
            success: function (result) {
                var listItem = [];
                result.forEach(elements => listItem.push({text: elements.Text, value: elements.Value}));
                var dataSource = new kendo.data.HierarchicalDataSource({
                    data:  listItem
                });
                child.setDataSource(dataSource);
                child.enable(true);
                child.trigger("change");
            }
        });
    }

    $.OnChangeLine = function (e) {
        var lines = $("#line").data("kendoDropDownTree").value();

        var lineValue = [];

        lines.forEach(
            line =>
                lineValue.push(line.split('#')[0])
        )

        var child = $("#group").data("kendoDropDownTree");
        $.ajax({
            method: "POST",
            url: "@Url.Content("~/api/payroll-detail//get-group")",
            dataType: "json",   
            data: { LineList: lineValue },
            success: function (result) {
                var listItem = [];
                result.forEach(elements => listItem.push({text: elements.Text, value: elements.Value}));
                var dataSource = new kendo.data.HierarchicalDataSource({
                    data:  listItem
                });
                child.setDataSource(dataSource);
                child.enable(true);
                child.trigger("change");
            }
        });
    }

    function getGridReport() {
        return $("#gridReport").data("kendoGrid");
    }

     $.getDataReport = function () {
        return {
            keyDate: kendo.toString($("#periode").data("kendoDatePicker").value(), 'yyyy-MM-dd')
        };   
    };

    function EmployeeSelect(e)
    {
        var DataItem = this.dataItem(e.item.index());
        $("#SelectedNoReg").val(DataItem.NoReg);
    }

    $.onSearch = function () {
        //debugger;
        var $grid = getGridReport();
        if (typeof $grid === 'undefined' || typeof $grid.dataSource === 'undefined') return;
        var dataSource = $grid.dataSource,
            employeeName = $("#employeeName").val();

        var selectedNoReg = $("#SelectedNoReg").val();
        
        var directorateList = $("#directorate").data("kendoDropDownTree").value();
        var divisionList = $("#division").data("kendoDropDownTree").value();
        var departmentList = $("#department").data("kendoDropDownTree").value();
        var sectionList = $("#section").data("kendoDropDownTree").value();
        var lineList = $("#line").data("kendoDropDownTree").value();
        var groupList = $("#group").data("kendoDropDownTree").value();
        
        var Class = $("#class").val();
        var type = $("#type").data("kendoComboBox").value();
        
        var finalFilter = {
            logic: "and",
            filters: []
        }
        
        //DIRECTORATE FILTER
        if(directorateList.length > 0){
            var directorateFilter =
                {
                    logic: "or",
                    filters: []
                };
            directorateList.forEach(
                directorate =>
                directorateFilter.filters.push(
                    {
                        field: 'Directorate',
                        operator: 'eq',
                        value: directorate.split('#')[1]
                    }
                )
            )
            finalFilter.filters.push(directorateFilter);
        }
        
        //DIVISION FILTER
        if(divisionList.length > 0){
            var divisionFilter =
                {
                    logic: "or",
                    filters: []
                };
            divisionList.forEach(
                division =>
                divisionFilter.filters.push(
                    {
                        field: 'Division',
                        operator: 'eq',
                        value: division.split('#')[1]
                    }
                )
            )
            finalFilter.filters.push(divisionFilter);
        }
        
        //DEPARTMENT FILTER
        if(departmentList.length > 0){
            var departmentFilter = 
                {
                    logic: "or",
                    filters: []
                };
            departmentList.forEach(
                department =>
                departmentFilter.filters.push(
                    {
                        field: 'Department',
                        operator: 'eq',
                        value: department.split('#')[1]
                    }
                )
            )
            finalFilter.filters.push(departmentFilter);
        }
        
        //SECTION FILTER
        if(sectionList.length > 0){
            var sectionFilter = 
                {
                    logic: "or",
                    filters: []
                };
            sectionList.forEach(
                section =>
                sectionFilter.filters.push(
                    {
                        field: 'Section',
                        operator: 'eq',
                        value: section.split('#')[1]
                    }
                )
            )
            finalFilter.filters.push(sectionFilter);
        }
        
        //LINE FILTER
        if(lineList.length > 0){
            var lineFilter = 
                {
                    logic: "or",
                    filters: []
                };
            lineList.forEach(
                line =>
                lineFilter.filters.push(
                    {
                        field: 'Line',
                        operator: 'eq',
                        value: line.split('#')[1]
                    }
                )
            )
            finalFilter.filters.push(lineFilter);
        }
        
        //GROUP FILTER
        if(groupList.length > 0){
            var groupFilter = 
                {
                    logic: "or",
                    filters: []
                };
            groupList.forEach(
                group =>
                groupFilter.filters.push(
                    {
                        field: 'Group',
                        operator: 'eq',
                        value: group.split('#')[1]
                    }
                )
            )
            finalFilter.filters.push(groupFilter);
        }
        
        if (Class != "") {
            finalFilter.filters.push({
                field: 'Class',
                operator: 'eq',
                value: Class
            });
        }
        
        finalFilter.filters.push({
            field: 'Name',
            operator: 'contains',
            value: employeeName
        });

        if(selectedNoReg != ""){
            finalFilter.filters.push({
                field: 'NoReg',
                operator: 'contains',
                value: selectedNoReg
            });
        }

        if(type != ""){
            finalFilter.filters.push({
                field: 'OTType',
                operator: 'eq',
                value: type
            });
        }
        
        dataSource.filter(finalFilter);

        var date = $("#periode").data("kendoDatePicker").value();

        var periodDate = new Date(date);

        periodDate = periodDate.addMonths(1);

        $('#titleSummary').text('@Localizer["PAYROLL PERIOD"]' + " " + kendo.toString(periodDate, 'MMMM yyyy'));
    };

    app.registerHandler("downloadReportHandler", function () {
        var periode = kendo.toString($("#periode").data("kendoDatePicker").value() || new Date(), "yyyy-MM-dd");

        console.log(periode);
    
        var directorateList = $("#directorate").data("kendoDropDownTree").value();
        var divisionList = $("#division").data("kendoDropDownTree").value();
        var departmentList = $("#department").data("kendoDropDownTree").value();
        var sectionList = $("#section").data("kendoDropDownTree").value();
        var lineList = $("#line").data("kendoDropDownTree").value();
        var groupList = $("#group").data("kendoDropDownTree").value();
    
        var directorateValue = [];
        directorateList.forEach(
            directorate =>
            directorateValue.push(
                directorate.split('#')[1]
            )
        )
    
        var divisionValue = [];
        divisionList.forEach(
            division =>
            divisionValue.push(
                division.split('#')[1]
            )
        )
    
        var departmentValue = [];
        departmentList.forEach(
            department =>
            departmentValue.push(
                department.split('#')[1]
            )
        )
    
        var sectionValue = [];
        sectionList.forEach(
            section =>
            sectionValue.push(
                section.split('#')[1]
            )
        )
    
        var lineValue = [];
        lineList.forEach(
            line =>
            lineValue.push(
                line.split('#')[1]
            )
        )
    
        var groupValue = [];
        groupList.forEach(
            group =>
            groupValue.push(
                group.split('#')[1]
            )
        )
    
        var Class = $("#class").val();
        var employeeName = $("#employeeName").val();

        var selectedNoReg = $("#SelectedNoReg").val();

        var type = $("#type").data("kendoComboBox").value();
    
        window.open(app.resolveUrl("~/api/payroll-detail/download-report?keyDate=" + periode + "&employeeName=" + employeeName + "&listDirectorate=" + encodeURIComponent(directorateValue) + "&listDivision=" + encodeURIComponent(divisionValue) + "&listDepartment=" + encodeURIComponent(departmentValue) + "&listSection=" + encodeURIComponent(sectionValue) + "&listLine=" + encodeURIComponent(lineValue) + "&listGroup=" + encodeURIComponent(groupValue) + "&class=" + Class + "&noReg=" + selectedNoReg + "&type=" + type ), "_blank");
    });

    $.OnDataBound = function (e) {
        var data = this.dataSource.data();
        if(firstTimeLoad){  
            SeedType();
            firstTimeLoad = false;
        }
    }

    function SeedType(){
        var listItem = [];
        listItem.push('LKL');
        listItem.push('BDJK');

        var TypeDropDown = $("#type").data("kendoComboBox");

        var dataSource = new kendo.data.HierarchicalDataSource({
            data:  listItem
        });

        TypeDropDown.setDataSource(dataSource);
        TypeDropDown.SelectedIndex = -1;
    }

</script>