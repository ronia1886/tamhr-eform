@{
    Layout = "~/Views/Shared/_Layout.cshtml";
    ScriptManager.RegisterReferences("grid", "combobox", "pdfviewer", "datepicker");

    var now = DateTime.Now.Date;
    var currentPeriod = now.Year;
    var currentMonth = now.Month;
    var offsetYear = 2020;

    var periods = Enumerable.Range(offsetYear, (currentPeriod - offsetYear) + 1)
        .OrderByDescending(x => x);

    var start = new DateTime(now.Year, now.Month, 1);
    var end = start.AddMonths(1).AddDays(-1);
}
@section scripts {
    <partial name="_Script" />
    <partial name="_ActionScript" />
    <partial name="ModalFeedback" />
    <partial name="ModalLiveChat" />
    <partial name="ModalNewConsult" />
    <script type="text/javascript" src="~/plugins/A/Axios/axios.min.js"></script>
    <script type="text/javascript" src="~/plugins/M/Moment/moment.js"></script>
}
@await Html.PartialAsync("ModalSelectService")
@section pageToolbars {
    <div>
        <a class="btn btn-sm red-sunglo" id="btnNewConsult" onclick="OpenNewConsult();">
            <i class="ft-settings"></i> <span class="d-none d-sm-inline">
                @Localizer["Create New Consultation"]
            </span></i>
        </a>
    </div>
}
@Html.AntiForgeryToken()
<style>
    .ColumnCenter {
        display: flex;
        flex-direction: column;
        gap: 4px;
        width: auto;
        align-items: center;
    }
    .OpenFeedback {
        border: none;
        background: #25D366;
    }
</style>
<script type="text/javascript">
    var OpenNewConsult = () => {
        $("#mdlSelectService").modal("toggle");
    }
    var IsWorkingTime = () => {
        var Result = false;
        if (moment().day()<6 && moment().isAfter(moment().hour(8).minute(0)) && moment().isBefore(moment().hour(17).minute(0))) {
            Result = true;
        }
        return Result;
    };
    var IsNotWorkingTime = () => {
        return !IsWorkingTime();
    };
    function FilterCategory() {
        var data = ["Konsultasi Kesehatan", "Konsultasi Asuransi", "Kebijakan Kesehatan", "Kebijakan Keselamatan (Safety)"];
        var option = '<option value="">All</option>'
        data.forEach(e => {
            option += `<option value='${e}'>${e}</option>`
        });
        $("#fCategory").html(option);
    }
    var showOutOfService = () => {
        Swal.fire({
            title: "Perhatian",
            html: '<div style="white-space: pre-line;">Selamat datang di layanan TanyaOHS\nMohon maaf. Tenaga Kesehatan sedang tidak tersedia.\nLayanan TanyaOHS tersedia Senin-Jumat, pk.08.00-17.00 (kec.hari libur)\nTinggalkan pesan Anda dan pesan tersebut akan  segera kami balas\nTerimakasih</div>',
            icon: "success",
            showConfirmButton: false
        });
    }
    document.addEventListener("DOMContentLoaded", function (event) {
        FilterCategory();
        //if (IsNotWorkingTime()) showOutOfService();
    });
</script>
<script>
    var ActionClick = (Id, KategoriLayanan) => {
        if (KategoriLayanan == "Konsultasi Kesehatan" || KategoriLayanan == "Konsultasi Asuransi") {
            OpenChat(Id);
        }
        if (KategoriLayanan == "Kebijakan Kesehatan") {
            window.location.href = `./KebijakanKesehatan?Id=${Id}`;
        }
        if (KategoriLayanan == "Kebijakan Keselamatan (Safety)") {
            window.location.href = `./KebijakanKeselamatan?Id=${Id}`;
        }
    }
    document.addEventListener("DOMContentLoaded", function (event) {
        function getPeriod() {
            var startDate = kendo.toString($("#StartDate").data("kendoDatePicker").value() || new Date(1800, 0, 1), "yyyy-MM-dd"),
                endDate = kendo.toString($("#EndDate").data("kendoDatePicker").value() || new Date(9999, 12, 31), "yyyy-MM-dd");

            return [{
                field: "CreatedOnSearch",
                operator: "gte",
                value: startDate
            }, {
                field: "CreatedOnSearch",
                operator: "lte",
                value: endDate
            }];
        }
        $.filterChange = function () {
            var $grid = $("#grid").data("kendoGrid");

            if (typeof $grid === 'undefined' || typeof $grid.dataSource === 'undefined') return;

            var dataSource = $grid.dataSource,
                fCategory = $("#fCategory").val(),
                filters = [...[{
                    field: 'UserId',
                    operator: 'eq',
                    value: '@User.GetClaim("Id")'
                }, {
                    field: 'KategoriLayanan',
                    operator: 'contains',
                    value: fCategory
                }],...getPeriod()];

            dataSource.filter(filters);
        };
        $("#fCategory").change(() => { $.filterChange() });
    });
</script>
<div class="card">
    <div class="card-header bordered">
        <div class="row">
            <div class="col-md-6 col-sm-12">
                <div class="form-group">
                    <label>
                        @Localizer["Service Category"]
                    </label>
                    <select id="fCategory" class="form-control">
                        <option value="">All</option>
                    </select>
                </div>
            </div>
            <div class="col-md-6 col-sm-12">
                <div class="form-group">
                    <label>
                        @Localizer["Date Range"]
                    </label>
                    <div class="row">
                        <div class="col-md-6 col-sm-12">
                            @(Html.Kendo().DatePicker()
                                .Name("StartDate")
                                .Value(start)
                                .Events(e => e.Change("$.filterChange"))
                                .Format("dd/MM/yyyy")
                                .HtmlAttributes(new { placeholder = "From", style = "width:100%" })
                                .Deferred()
                                )
                        </div>
                        <div class="col-md-6 col-sm-12">
                            @(Html.Kendo().DatePicker()
                                .Name("EndDate")
                                .Value(end)
                                .Events(e => e.Change("$.filterChange"))
                                .Format("dd/MM/yyyy")
                                .HtmlAttributes(new { placeholder = "From", style = "width:100%" })
                                .Deferred()
                                )
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="card-body p-0">
        <div class="col-md-12">
            @(Html.Kendo().Grid<TAMHR.ESS.Domain.TanyaOhs>
                ()
                .Name("grid")
                .HtmlAttributes(new { @class = "not-hoverable table-fixed-header" })
                .Columns(columns =>
                {
                    columns.Template("" +
                        "#:Nama# <button class=\"btn btn-danger\" onclick=\"OpenChat('#:Id#')\" style=\"#if(IsKonsultasiReadUser == 1) {# display:none # }#\">" +
                        "<i class=\"fa fa-exclamation-triangle\"></i>" +
                        "</button>").Title("Nama").Width(200);
                    columns.Bound(c => c.Noreg).Title("Noreg").Width(100);
                    columns.Bound(c => c.Keluhan).Title(Localizer["Complaint"].Value).Width(100);
                    columns.Bound(c => c.KategoriLayanan).Title(Localizer["Service Category"].Value).Width(100);
                    columns.Bound(c => c.CreatedOn).Format("{0:dd/MM/yyyy}").Title(Localizer["Date"].Value).Width(100);
                    columns.Bound(c => c.Solve).Title(Localizer["Solve"].Value).Width(100);
                    columns.Bound(c => c.Status).Title("Status").Width(100);
                    columns.Template("" +
                        "<div class=\"ColumnCenter\">"
                        +
                        "<button class=\"btn btn-primary\" onclick=\"ActionClick('#:Id#','#:KategoriLayanan#')\" style=\"#if(Status == 'Closed-disable') {# display:none # }#\">" +
                        "<i class=\"icon-eye\"></i>" +
                        "</button>" +
                        "<button class=\"btn btn-primary OpenFeedback\" onclick=\"OpenFeedback('#:Id#')\" style=\" #if(Status == 'Closed') {# display:block # } else {# display:none #}#\">" +
"<i class=\"fa fa-reply\"></i></button>" +
                        "</div>"
                    ).Title(Localizer["Action"].Value).Width(100);
                })
                .DataSource(dataSource => dataSource
                .Ajax()
                .Read(read => read.Url(Url.Content("~/api/tanyaOHS/gets")).Data("$.getData"))
                .Sort(sort =>
                {
                })
                .Filter(filter => {
                    filter.Add(x => x.UserId).IsEqualTo(User.GetClaim("Id"));
                })
                .PageSize(20)
                )
                .Pageable(options =>
                {
                    options.Input(true);
                    options.Numeric(false);
                    options.PageSizes(new[] { 5, 10, 20, 25, 100, 200 });
                })
                .HtmlAttributes(new { style = "height:600px;" })
                .Sortable()
                .Resizable(resizable => resizable.Columns(true))
                .NoRecords(config => config.Template(@"<div class="" text-center p-2 text-muted""><i class="" fa fa-clipboard font-large-1""></i><br />" + Localizer["No data found"].Value + "</div>"))
                .Scrollable()
                .Events(events =>
                {
                    events.DataBound("$.onDataBound");
                })
                .Deferred()
                )
        </div>
    </div>
</div>